# Структура базы данных Telegram Bot

## Общая информация

- **СУБД**: MySQL
- **Кодировка**: utf8mb4
- **Движок**: InnoDB (для поддержки внешних ключей)
- **Подключение**: через connection pool (mysql2/promise)

## Таблицы

### 1. Таблица `players`

**Назначение**: Хранение данных игроков и их статистики

**Структура полей**:
- `id` - BIGINT UNSIGNED, PRIMARY KEY (ID игрока из Telegram)
- `name` - VARCHAR(255), NOT NULL (Имя игрока, очищенное от эмодзи)
- `username` - VARCHAR(255) (Username игрока, очищенный от эмодзи)
- `goals` - INT, DEFAULT 0 (Забитые голы, накапливается)
- `assists` - INT, DEFAULT 0 (Голевые передачи, накапливается)
- `saves` - INT, DEFAULT 0 (Сейвы, накапливается)
- `gamesPlayed` - INT, DEFAULT 0 (Количество сыгранных игр, накапливается)
- `wins` - INT, DEFAULT 0 (Победы, накапливается)
- `draws` - INT, DEFAULT 0 (Ничьи, накапливается)
- `losses` - INT, DEFAULT 0 (Поражения, накапливается)
- `rating` - INT, DEFAULT 0 (Рейтинг игрока, обновляется, не накапливается)
- `mvp` - INT, DEFAULT 0 (Количество MVP, накапливается)

**Особенности**:
- При сохранении используется `ON DUPLICATE KEY UPDATE`
- Поля `goals`, `assists`, `saves`, `gamesPlayed`, `wins`, `draws`, `losses`, `mvp` - накапливаются (суммируются)
- Поле `rating` - обновляется (не суммируется)
- Поля `name` и `username` - обновляются (могут измениться)

**Файлы работы с таблицей**:
- `savePlayers.js` - сохранение/обновление данных игроков
- `getPlayerStats.js` - получение статистики игроков
- `getPlayerByName.js` - поиск игрока по имени или username
- `resetPlayersStats.js` - сброс статистики игроков

---

### 2. Таблица `teams`

**Назначение**: Хранение данных команд и их статистики

**Структура полей**:
- `id` - INT, AUTO_INCREMENT, PRIMARY KEY
- `name` - VARCHAR(100), NOT NULL, UNIQUE (Название команды, уникальное)
- `tournament_count` - INT, DEFAULT 0 (Количество турниров, накапливается)
- `points` - INT, DEFAULT 0 (Очки команды, накапливается)
  - 1 место: +3 очка
  - 2 место: +2 очка
  - 3 место: +1 очко
- `wins` - INT, DEFAULT 0 (Победы команды, накапливается)
- `draws` - INT, DEFAULT 0 (Ничьи команды, накапливается)
- `losses` - INT, DEFAULT 0 (Поражения команды, накапливается)
- `goals_scored` - INT, DEFAULT 0 (Забитые голы, накапливается)
- `goals_conceded` - INT, DEFAULT 0 (Пропущенные голы, накапливается)

**Особенности**:
- Название команды уникально (UNIQUE KEY)
- Все статистические поля накапливаются при каждом турнире
- Команды с дефолтными названиями "Команда 1", "Команда 2" и т.д. НЕ сохраняются в базу

**Файлы работы с таблицей**:
- `saveTeams.js` - сохранение/обновление данных команд

---

### 3. Таблица `team_players`

**Назначение**: Связующая таблица между командами и игроками (состав команд)

**Структура полей**:
- `team_id` - INT, NOT NULL, FOREIGN KEY → teams(id) ON DELETE CASCADE
- `player_id` - BIGINT UNSIGNED, NOT NULL, FOREIGN KEY → players(id) ON DELETE CASCADE
- `team_name` - VARCHAR(100), NOT NULL (Название команды, для удобства просмотра)
- `name` - VARCHAR(255), NOT NULL (Имя игрока, для удобства просмотра)
- `username` - VARCHAR(255) (Username игрока, для удобства просмотра, может быть NULL)

**Первичный ключ**: Составной PRIMARY KEY (team_id, player_id)

**Особенности**:
- Один игрок может быть только в одной команде (проверка по player_id)
- Если игрок уже есть в какой-то команде, он не добавляется в новую команду
- При удалении команды или игрока, связанные записи удаляются автоматически (CASCADE)
- Поля `team_name`, `name`, `username` хранятся для удобства просмотра без JOIN

**Файлы работы с таблицей**:
- `saveTeams.js` - сохранение состава команд

---

## Связи между таблицами

```
players (id) ←─── team_players (player_id)
                      ↓
teams (id) ←───────────┘ (team_id)
```

- `team_players.team_id` → `teams.id` (ON DELETE CASCADE)
- `team_players.player_id` → `players.id` (ON DELETE CASCADE)

---

## Логика работы

### Сохранение игроков (`savePlayers.js`)
1. Получает массив игроков с их статистикой
2. Очищает имена и username от эмодзи
3. Получает текущие рейтинги из БД
4. Вычисляет новый рейтинг (текущий + изменение)
5. Сохраняет/обновляет данные с накоплением статистики

### Сохранение команд (`saveTeams.js`)
1. Определяет места команд в турнире (по победам, разнице мячей, забитым мячам)
2. Начисляет очки за места (1-е: 3, 2-е: 2, 3-е: 1)
3. Пропускает команды с дефолтными названиями ("Команда 1", "Команда 2" и т.д.)
4. Создает или обновляет команду в таблице `teams`
5. Сохраняет состав команды в `team_players`:
   - Проверяет, есть ли игрок уже в какой-то команде
   - Если игрок уже в команде - пропускает его
   - Если игрока нет - добавляет в текущую команду

---

## Важные замечания

1. **Кодировка**: Все таблицы используют utf8mb4 для поддержки эмодзи и специальных символов
2. **Очистка эмодзи**: Имена и username очищаются от эмодзи перед сохранением
3. **Накопление статистики**: Большинство полей статистики накапливаются (суммируются), кроме рейтинга
4. **Уникальность**: 
   - Название команды уникально
   - Комбинация (team_id, player_id) уникальна
   - Один игрок может быть только в одной команде
5. **Каскадное удаление**: При удалении команды или игрока, связанные записи в `team_players` удаляются автоматически
